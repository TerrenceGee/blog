---
sidebar_position: 1
sidebar_label: '微服务架构理念'
---

# theory

## 服务发现

类库封闭+编译链接：软件规模发展的第一次飞跃
服务发现（Service Discovery）：可与之相提并论的第二次飞跃（如果要与类库调用作对比，服务发现+服务调用合并起来称为飞跃更为合理）

服务对外地址信息：

1. 全限定名
2. 端口号
3. 服务标识

- 服务注册(Service Registration): 服务启动的时候，它应该能够通过某些形式将自己的坐标信息通知到服务注册中心
  - 调用API
  - 产生事件消息
  - zk/Etcd中指定位置记录
  - 存入数据库
- 服务维护(Service Maintaining): 确认服务的健康状态，死亡服务优雅地下线
  - 支持多种协议(HTTP, TCP)
  - 多种方式（长连接、心跳、探针、进程状态）
- 服务发现(Service Discovery): 消费服务通过服务发现的信号找到目标服务提供者提供的具体服务的过程
  - HTTP API请求
  - DNS Lookup
  - k8s注入环境变量

![注册中心抽象模型](/static/img/docs/web/注册中心抽象模型.png)

在生产环境中，一般注册中心也是高可用集群部署的，由于配置中心与注册中心地位的相似性，且为了避免另一个配置中心集群，注册中心便集成了配置中心的功能。
一般集群取3，5，7个节点，不宜太多，否则复制日志的开销太大。

![注册中心生产模型](/static/img/docs/web/注册中心生产模型.png)

### 注册中心CAP的抉择

- AP代表：Eureka，节点间采用异步复制来交换服务注册信息。服务注册时，该节点马上宣告服务可见，随后其他节点复制陆续完成。旧服务变动，不会实时同步给所有服务端和客户端，而是由超时机制来控制。
Eureka（此类AP注册中心的实现）适合不会频繁上下线的系统。
Eureka敢于牺牲服务状态一致性的原因是，即使客户端拿到了过时的错误地址，也可以通过Ribbon和Hystrix模型配合来兜底，实现故障转移(Failover)或(Failfast)。
- CP代表：Consul，Consistence，Consul采用`Raft`算法，多数派节点写入成功后服务的注册或变动才算完成，严格保证服务读取状态一致性；同时采用Gossip协议，支持多数据中心之间更大规模的服务同步。
Consul牺牲Available高可用性的原因是Netflix OSS没有全家桶式的微服务组件，如果服务状态一致性受损，没有其他组件兜底。

如何选择CAP原则的注册中心？
> 一个场景：系统形成两个分区A,B,且A区中的服务只能通过服务发现获取A区的服务坐标，B区亦然。

- 如果这件事情对系统没有影响，则可以选择AP高可用的注册中心方案。
- 如果这件事情是不可接受的，那么选择CP高一致的方案。

这里CP实现方案中出现了一个Raft算法，这是分布式系统中比较重要的算法。

## Raft算法
